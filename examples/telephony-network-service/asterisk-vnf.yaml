tosca_definitions_version: tosca_simple_yaml_1_3

imports:

- namespace_prefix: ns
  file: profiles/network-service/profile.yaml
- namespace_prefix: telephony
  file: profiles/telephony/profile.yaml
- namespace_prefix: mariadb
  file: profiles/mariadb/profile.yaml
- namespace_prefix: k8s
  file: profiles/kubernetes/1.18/profile.yaml
- namespace_prefix: kubevirt
  file: profiles/kubevirt/0.29.0/profile.yaml
- namespace_prefix: o11n
  file: profiles/orchestration/1.0/profile.yaml

node_types:

  Asterisk:
    capabilities:
      metadata: k8s:Metadata
      virtual-machine: kubevirt:VirtualMachine
      tcp: k8s:LoadBalancer
      udp: k8s:LoadBalancer
      connection: ns:Connectable
    requirements:
    - data-plane:
        capability: ns:Connectable
        node: ns:NetworkPlane
    - db:
        capability: mariadb:Connectable
    interfaces:
      configuration:
        type: o11n:SSHConfiguration

topology_template:

  inputs:

    namespace:
      type: string
      default: workspace

  node_templates:

    vnf:
      type: Asterisk
      capabilities:
        metadata:
          properties:
            name: asterisk-vnf
            namespace: { get_input: namespace }
            labels:
              app.kubernetes.io/name: asterisk-vnf
              app.kubernetes.io/instance: { concat: [ asterisk-vnf-, { get_input: namespace } ] }
        virtual-machine:
          properties:
            template:
              # Multithreadedness breaks the machine (because of nested virtualization?)
              #cpu:
              #  cores: 2
              #  threads: 4
              domain:
                resources:
                  requests:
                    memory: 1024M
                devices:
                  disks:
                  - name: containerdisk
                    disk: {}
                  - name: cloudinitdisk
                    disk: {}
                  interfaces:
                  - name: control-plane
                    bridge: {}
                  - name: data-plane
                    bridge: {}
              networks:
              - name: control-plane
                pod: {}
              - name: data-plane
                multus:
                  networkName: { get_property: [ data-plane, annotations, name ] }
              volumes:
              - name: containerdisk
                containerDisk:
                  image: { get_artifact: [ SELF, image ] }
                  imagePullPolicy: Always
              - name: cloudinitdisk
                cloudInitNoCloud:
                  userDataBase64: { get_artifact: [ SELF, cloud-config ] }
        tcp:
          properties:
            ports:
            - { name: ssh, protocol: TCP, targetPort: 22, port: 22 }
        udp:
          properties:
            ports:
            - { name: sip, protocol: UDP, targetPort: 5060, port: 5060 }
            - { name: rtp0, protocol: UDP, targetPort: 10000, port: 10000 }
            - { name: rtp1, protocol: UDP, targetPort: 10001, port: 10001 }
            - { name: rtp2, protocol: UDP, targetPort: 10002, port: 10002 }
            - { name: rtp3, protocol: UDP, targetPort: 10003, port: 10003 }
            - { name: rtp4, protocol: UDP, targetPort: 10004, port: 10004 }
            - { name: rtp5, protocol: UDP, targetPort: 10005, port: 10005 }
            - { name: rtp6, protocol: UDP, targetPort: 10006, port: 10006 }
            - { name: rtp7, protocol: UDP, targetPort: 10007, port: 10007 }
      interfaces:
        configuration:
          inputs:
            host: TODO #{ get_attribute: [ SELF, ip ] }
            username: admin
            key: { get_artifact: [ SELF, private-key ] }
          operations:
            configure: configure
      artifacts:
        image:
          type: k8s:ContainerImage
          file: artifacts/images/asterisk-vnf.tar.gz
          properties:
            tag: asterisk-vnf
        private-key:
          type: o11n:Key
          file: artifacts/keypairs/admin@asterisk-vnf
        public-key:
          type: o11n:Key
          file: artifacts/keypairs/admin@asterisk-vnf.pub
        cloud-config:
          type: kubevirt:CloudConfig
          file: artifacts/cloud-config/asterisk-vnf.yaml
          properties:
            base64: true
            variables:
              $KEY: { get_artifact: [ SELF, public-key ] }
        configure:
           type: o11n:ShellScript
           file: artifacts/scripts/asterisk/configure.sh

    db:
      type: mariadb:Cluster
      properties:
        database: asterisk
        username: asterisk
        password: asterisk
        rootpwd: asterisk

    data-plane:
      type: ns:NetworkPlane
      # TODO: inject these via substitution mapping
      properties:
        annotations:
          name: data-plane

  substitution_mappings:

    node_type: telephony:PBX
    capabilities:
      connection: [ vnf, connection ]

  policies:

  - data-plane:
      type: o11n:Provisioning
      properties:
        instantiable: false
      targets:
      - data-plane
