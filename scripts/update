#!/bin/bash
set -e

HERE=$(dirname "$(readlink --canonicalize "$BASH_SOURCE")")
. "$HERE/_env"
. "$HERE/_trap"

minikube profile edge
turandot uninstall -n workspace
minikube profile central
turandot uninstall -n workspace

if [ "$1" == -b ]; then
	"$HERE/build-container-image"
	"$HERE/publish-container-image"
else
	sleep 10
fi

turandot install -s central -n workspace -w -v
kubectl config set-context --current --namespace=workspace

sleep 20

turandot service deploy hello-world -f dist/hello-world.csar -v

turandot delegate set edge --delegate-context=edge

turandot template register telephony-network-service -f dist/telephony-network-service.csar -v
turandot template register simple-data-plane -f dist/simple-data-plane.csar -v
turandot template register asterisk-cnf -f dist/asterisk-cnf.csar -v
turandot template register asterisk-vnf -f dist/asterisk-vnf.csar -v

turandot service deploy telephony-network-service -t telephony-network-service -i namespace=workspace -v

echo Done!

# Clean ~/.local/share/containers/ occassionally!
